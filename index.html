<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J+D Partner Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif; /* Fallback for GT Sectra */
            background-color: #373737;
            color: #E1E1E1;
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: rgba(55, 55, 55, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 0, 100, 0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 300;
            color: #E1E1E1;
            letter-spacing: 0.5px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            font-family: 'Monaco', monospace; /* Fallback for GT Pressura Mono */
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .data-info {
            padding: 5px 10px;
            background-color: rgba(255, 0, 100, 0.1);
            border: 1px solid #FF0064;
            border-radius: 2px;
            color: #FF0064;
        }
        
        #map {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }
        
        /* Custom Leaflet Styles */
        .leaflet-container {
            background-color: #373737;
        }
        
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: none !important;
        }
        
        .leaflet-control-zoom a {
            background-color: rgba(55, 55, 55, 0.9) !important;
            border: 1px solid #FF0064 !important;
            color: #FF0064 !important;
            font-weight: bold !important;
        }
        
        .leaflet-control-zoom a:hover {
            background-color: #FF0064 !important;
            color: #373737 !important;
        }
        
        .leaflet-popup-content-wrapper {
            background-color: rgba(55, 55, 55, 0.95) !important;
            border: 1px solid #FF0064 !important;
            border-radius: 2px !important;
            box-shadow: 0 4px 20px rgba(255, 0, 100, 0.3) !important;
        }
        
        .leaflet-popup-content {
            color: #E1E1E1 !important;
            font-family: 'Monaco', monospace !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
        }
        
        .leaflet-popup-tip {
            background-color: rgba(55, 55, 55, 0.95) !important;
            border: 1px solid #FF0064 !important;
        }
        
        .county-info h3 {
            color: #FF0064;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .county-info p {
            margin-bottom: 4px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FF0064;
            font-size: 18px;
            z-index: 1000;
        }
        
        /* Add Partner Button Styles */
        .add-partner-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background-color: #FF0064;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 0, 100, 0.3);
            transition: all 0.3s ease;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }
        
        .add-partner-btn:hover {
            background-color: #e00559;
            transform: translateY(-1px);
            box-shadow: 0 6px 25px rgba(255, 0, 100, 0.4);
        }
        
        .add-partner-btn.active {
            background-color: #50F5C8;
            color: #373737;
        }
        
        .add-partner-btn.active:hover {
            background-color: #3dd4a8;
        }
        
        /* Mode indicator */
        .mode-indicator {
            position: fixed;
            top: 100px;
            left: 20px;
            z-index: 1000;
            background-color: rgba(55, 55, 55, 0.9);
            border: 1px solid #FF0064;
            padding: 10px 15px;
            border-radius: 3px;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            color: #FF0064;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            display: none;
        }
        
        .mode-indicator.visible {
            display: block;
        }
        
        /* Force crosshair cursor in add mode */
        #map.add-mode,
        #map.add-mode * {
            cursor: crosshair !important;
        }
        
        /* Partner Form Modal */
        .partner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(55, 55, 55, 0.6);
            backdrop-filter: blur(3px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .partner-modal.visible {
            display: flex;
        }
        
        .partner-modal-content {
            background-color: #373737;
            border: 2px solid #FF0064;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(255, 0, 100, 0.3);
        }
        
        .partner-modal h2 {
            color: #FF0064;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
            font-family: 'Georgia', serif;
        }
        
        .partner-form-group {
            margin-bottom: 20px;
        }
        
        .partner-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #E1E1E1;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .partner-form-group input,
        .partner-form-group select,
        .partner-form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #FF0064;
            background: #2a2a2a;
            color: #E1E1E1;
            border-radius: 4px;
            font-family: 'Georgia', serif;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .partner-form-group input:focus,
        .partner-form-group select:focus,
        .partner-form-group textarea:focus {
            outline: none;
            border-color: #50F5C8;
            box-shadow: 0 0 5px rgba(80, 245, 200, 0.3);
        }
        
        .partner-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .partner-form-coordinates {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .partner-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .partner-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .partner-btn-primary {
            background: #FF0064;
            color: white;
        }
        
        .partner-btn-primary:hover {
            background: #e00559;
            transform: translateY(-1px);
        }
        
        .partner-btn-secondary {
            background: #666;
            color: white;
        }
        
        .partner-btn-secondary:hover {
            background: #555;
            transform: translateY(-1px);
        }
        
        /* Save Progress Indicator */
        .save-progress {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .save-progress.hidden {
            display: none;
        }
        
        .save-progress.info {
            background: rgba(20, 60, 255, 0.1);
            color: #143CFF;
            border: 1px solid rgba(20, 60, 255, 0.3);
        }
        
        .save-progress.success {
            background: rgba(220, 245, 0, 0.1);
            color: #DCF500;
            border: 1px solid rgba(220, 245, 0, 0.3);
        }
        
        .save-progress.error {
            background: rgba(255, 0, 100, 0.1);
            color: #FF0064;
            border: 1px solid rgba(255, 0, 100, 0.3);
        }
        
        .partner-btn-geocode {
            background: #143CFF;
            color: white;
            font-size: 11px;
            padding: 8px 12px;
            margin-top: 8px;
        }
        
        .partner-btn-geocode:hover {
            background: #0f2ecc;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #FF0064;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #e00559;
            transform: scale(1.1);
        }
        
        .geocoding-status {
            font-size: 11px;
            margin-top: 5px;
            font-family: 'Monaco', monospace;
        }
        
        .geocoding-success {
            color: #50F5C8;
        }
        
        .geocoding-error {
            color: #FF6B35;
        }
        
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .title {
                font-size: 18px;
            }
            
            .controls {
                font-size: 10px;
            }
            
            #map {
                top: 70px;
            }
            
            .add-partner-btn {
                font-size: 10px;
                padding: 8px 15px;
            }
            
            .mode-indicator {
                font-size: 10px;
                padding: 8px 12px;
            }
        }
        
        /* Custom Marker Cluster Styles */
        .marker-cluster-small {
            background-color: rgba(255, 0, 100, 0.8) !important;
            border: 2px solid #373737 !important;
        }
        .marker-cluster-small div {
            background-color: rgba(255, 0, 100, 0.9) !important;
            color: white !important;
            font-family: 'Monaco', monospace !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        .marker-cluster-medium {
            background-color: rgba(20, 60, 255, 0.8) !important;
            border: 2px solid #373737 !important;
        }
        .marker-cluster-medium div {
            background-color: rgba(20, 60, 255, 0.9) !important;
            color: white !important;
            font-family: 'Monaco', monospace !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        .marker-cluster-large {
            background-color: rgba(220, 245, 0, 0.8) !important;
            border: 2px solid #373737 !important;
        }
        .marker-cluster-large div {
            background-color: rgba(220, 245, 0, 0.9) !important;
            color: #373737 !important;
            font-family: 'Monaco', monospace !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        /* Authentication Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(55, 55, 55, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .auth-overlay.hidden {
            display: none;
        }
        
        .auth-message {
            background-color: #373737;
            border: 2px solid #FF0064;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(255, 0, 100, 0.3);
        }
        
        .auth-message h2 {
            color: #FF0064;
            margin-bottom: 20px;
            font-size: 28px;
            font-family: 'Georgia', serif;
        }
        
        .auth-message p {
            color: #E1E1E1;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .btn-auth {
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Monaco', monospace;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            background: #FF0064;
            color: white;
            font-weight: bold;
        }
        
        .btn-auth:hover {
            background: #e00559;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 0, 100, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .user-info.hidden {
            display: none;
        }
        
        .user-email {
            color: #50F5C8;
            background-color: rgba(80, 245, 200, 0.1);
            border: 1px solid #50F5C8;
            padding: 5px 10px;
            border-radius: 2px;
        }
        
        .btn-logout {
            padding: 5px 10px;
            background-color: rgba(255, 0, 100, 0.1);
            border: 1px solid #FF0064;
            border-radius: 2px;
            color: #FF0064;
            cursor: pointer;
            font-family: 'Monaco', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background-color: #FF0064;
            color: white;
        }
        
        .auth-loading {
            color: #50F5C8;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <svg class="logo" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg">
                <rect fill="#fd0764" x="-.06" width="72" height="72"/>
                <g fill="#fff">
                    <path d="M13.82,57.61c0,.2.13.33.33.33h8.82c.37,0,.67.3.67.67v.8c0,.37-.3.67-.67.67h-10.62c-.37,0-.67-.3-.67-.67v-21.98c0-.37.3-.67.67-.67h.8c.37,0,.67.3.67.67v20.18Z"/>
                    <path d="M29.47,59.58c-.07.3-.33.5-.63.5h-.83c-.53,0-.73-.37-.67-.67l6.36-22.15c.07-.3.33-.5.63-.5h1.66c.3,0,.57.2.63.5l6.36,22.15c.07.3-.13.67-.67.67h-.83c-.3,0-.57-.2-.63-.5l-1.63-5.63c-.1-.3-.33-.47-.63-.47h-6.86c-.3,0-.53.17-.63.47l-1.63,5.63ZM31.96,51.05c-.07.27.07.37.27.37h5.86c.2,0,.33-.1.27-.37l-3.03-11.32c-.03-.13-.07-.2-.13-.2h-.07c-.07,0-.1.07-.13.2l-3.03,11.32Z"/>
                    <path d="M58.17,48.19c1.37,1.1,2.36,3.2,2.36,5.1,0,3.86-3.16,6.79-6.99,6.79h-5.83c-.37,0-.67-.3-.67-.67v-21.98c0-.37.3-.67.67-.67h5.83c3.6,0,6.53,2.6,6.53,6.19,0,1.53-.63,3.4-1.9,4.5-.27.23-.27.53,0,.73ZM49.45,38.9c-.2,0-.33.13-.33.33v7.29c0,.2.13.33.33.33h4.6c2.2,0,3.93-1.76,3.93-3.96s-1.73-4-3.93-4h-4.6ZM53.91,57.95c2.53,0,4.56-2.03,4.56-4.56s-2.03-4.56-4.56-4.56h-4.46c-.2,0-.33.13-.33.33v8.46c0,.2.13.33.33.33h4.46Z"/>
                    <path d="M13.98,23.04c0,.84.67,1.51,1.7,1.51s1.67-.65,1.67-1.7v-8.55c0-.21.17-.37.37-.37h1.88c.21,0,.37.17.37.37h0v8.74c0,2.27-1.7,4.14-4.31,4.14-2.46,0-4.32-1.86-4.32-4.14v-.52c0-.21.17-.37.37-.37h1.89c.21,0,.37.17.37.37v.52Z"/>
                    <path d="M50.68,27.07c-.21,0-.37-.17-.37-.37v-12.3c0-.21.17-.37.37-.37h4.31c2.29,0,3.89,1.88,4.16,4.12.19,1.6.19,3.21,0,4.81-.26,2.24-1.86,4.12-4.16,4.12h-4.31ZM54.98,24.46c.86,0,1.44-.69,1.53-1.51.19-1.6.19-3.21,0-4.81-.09-.82-.67-1.51-1.53-1.51h-1.88c-.1,0-.18.07-.19.16,0,0,0,.01,0,.02v7.46c0,.1.07.18.16.19,0,0,.01,0,.02,0h1.88Z"/>
                    <path d="M41.4,19.46h-5.02v-5.02c0-.21-.17-.37-.37-.37h-1.67c-.21,0-.37.16-.38.37,0,0,0,0,0,0v5.02h-5.02c-.21,0-.37.17-.37.37v1.67c0,.21.17.37.37.37,0,0,0,0,0,0h5.02v4.77c0,.21.17.37.37.37h1.67c.21,0,.37-.17.37-.37v-4.77h5.02c.21,0,.37-.17.37-.37v-1.67c0-.2-.16-.37-.37-.37Z"/>
                </g>
            </svg>
            <div class="title">J+D Partner Network</div>
        </div>
        <div class="controls">
            <!-- User info (shown when authenticated) -->
            <div id="user-info" class="user-info hidden">
                <span class="user-email" id="user-email"></span>
                <button id="logout-btn" class="btn-logout">Logout</button>
            </div>
            
            <!-- Auth loading indicator -->
            <div id="auth-loading" class="auth-loading hidden">
                Authenticating...
            </div>
        </div>
    </div>
    
    <!-- Authentication Overlay -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-message">
            <h2>Authentication Required</h2>
            <p>Please login with your Airtable account to view and add partners to the J+D Network Map.</p>
            <p>Only members of the J+D workspace can access this application.</p>
            <button id="airtable-login-btn" class="btn-auth">Login with Airtable</button>
        </div>
    </div>

    <div id="loading" class="loading">Loading map data...</div>
    <div id="map"></div>
    
    <!-- Add Partner Button -->
    <button id="add-partner-btn" class="add-partner-btn" title="Toggle Add Partner Mode">
        Add Partner
    </button>
    
    <!-- Mode Indicator -->
    <div id="mode-indicator" class="mode-indicator">
        Add Partner Mode: Click map to add partner
    </div>
    
    <!-- Partner Form Modal -->
    <div id="partner-modal" class="partner-modal">
        <div class="partner-modal-content">
            <button class="modal-close" onclick="closePartnerModal()">&times;</button>
            <h2>Add New Partner</h2>
            
            <form id="partner-form">
                <div class="partner-form-group">
                    <label for="partner-name">Organization Name *</label>
                    <input type="text" id="partner-name" name="name" required>
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-type">Partner Type *</label>
                    <select id="partner-type" name="type" required>
                        <option value="">Select Type...</option>
                        <option value="Connector">Connector</option>
                        <option value="Information Hub">Information Hub</option>
                        <option value="Funder">Funder</option>
                        <option value="News Organization">News Organization</option>
                        <option value="Community College">Community College</option>
                        <option value="Library">Library</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-address">Address</label>
                    <input type="text" id="partner-address" name="address" placeholder="123 Main St, City, State, ZIP">
                    <button type="button" class="partner-btn partner-btn-geocode" onclick="geocodeAddress()">
                        üìç Lookup Coordinates
                    </button>
                    <div id="geocoding-status" class="geocoding-status"></div>
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-description">Description</label>
                    <textarea id="partner-description" name="description" placeholder="Brief description of the partner organization"></textarea>
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-contact">Contact Person</label>
                    <input type="text" id="partner-contact" name="contact" placeholder="Contact person name">
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-email">Contact Email</label>
                    <input type="email" id="partner-email" name="contactEmail" placeholder="contact@organization.com">
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-phone">Contact Phone</label>
                    <input type="tel" id="partner-phone" name="contactPhone" placeholder="(555) 123-4567">
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-project-link">Project Tracking Link</label>
                    <input type="url" id="partner-project-link" name="projectLink" placeholder="https://project-tracking-url.com">
                </div>
                
                <div class="partner-form-group">
                    <label for="partner-notes">Notes</label>
                    <textarea id="partner-notes" name="notes" placeholder="Additional notes or comments"></textarea>
                </div>
                
                <div class="partner-form-group">
                    <label>Coordinates</label>
                    <div class="partner-form-coordinates">
                        <div>
                            <label for="partner-lat">Latitude</label>
                            <input type="number" id="partner-lat" name="latitude" step="any" readonly>
                        </div>
                        <div>
                            <label for="partner-lng">Longitude</label>
                            <input type="number" id="partner-lng" name="longitude" step="any" readonly>
                        </div>
                    </div>
                </div>
                
                <div id="save-progress" class="save-progress hidden"></div>
                
                <div class="partner-modal-buttons">
                    <button type="button" class="partner-btn partner-btn-secondary" onclick="closePartnerModal()">
                        Cancel
                    </button>
                    <button type="submit" class="partner-btn partner-btn-primary" id="save-partner-btn">
                        Save Partner
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster Plugin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Partner Management System -->
    <script src="js/partners.js"></script>

    <script>
        // OAuth2 Configuration for Airtable
        const OAUTH_CONFIG = {
            clientId: 'INSERT_YOUR_CLIENT_ID', // You'll need to register at https://airtable.com/create/oauth
            redirectUri: window.location.origin + window.location.pathname,
            scope: 'data.records:read data.records:write user.email:read schema:read',
            airtableUrl: 'https://www.airtable.com',
            targetWorkspaceId: 'wsp521eG1mYR4mexh'
        };
        
        // Authentication state
        const authState = {
            isAuthenticated: false,
            accessToken: null,
            refreshToken: null,
            userEmail: null,
            userId: null,
            isLoading: false
        };
        
        // OAuth2 PKCE Utility Functions
        function generateRandomString(length) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return crypto.subtle.digest('SHA-256', data);
        }
        
        function base64urlencode(str) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        async function generateCodeChallenge(verifier) {
            const hashed = await sha256(verifier);
            return base64urlencode(hashed);
        }
        
        // OAuth2 Authentication Functions
        async function initiateOAuth() {
            console.log('üîê Starting OAuth flow...');
            
            // Generate PKCE parameters
            const state = generateRandomString(32);
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store PKCE parameters in sessionStorage
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('oauth_code_verifier', codeVerifier);
            
            // Build authorization URL
            const authUrl = new URL(`${OAUTH_CONFIG.airtableUrl}/oauth2/v1/authorize`);
            authUrl.searchParams.append('client_id', OAUTH_CONFIG.clientId);
            authUrl.searchParams.append('redirect_uri', OAUTH_CONFIG.redirectUri);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('scope', OAUTH_CONFIG.scope);
            authUrl.searchParams.append('state', state);
            authUrl.searchParams.append('code_challenge', codeChallenge);
            authUrl.searchParams.append('code_challenge_method', 'S256');
            
            console.log('üîó Redirecting to:', authUrl.toString());
            
            // Redirect to Airtable OAuth
            window.location.href = authUrl.toString();
        }
        
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            // Check for OAuth errors
            if (error) {
                console.error('‚ùå OAuth error:', error);
                showAuthError('Authentication failed: ' + error);
                return false;
            }
            
            // Verify we have the required parameters
            if (!code || !state) {
                console.log('‚ÑπÔ∏è No OAuth callback parameters found');
                return false;
            }
            
            // Verify state parameter
            const storedState = sessionStorage.getItem('oauth_state');
            if (state !== storedState) {
                console.error('‚ùå State parameter mismatch - possible CSRF attack');
                showAuthError('Security error: Invalid state parameter');
                return false;
            }
            
            console.log('‚úÖ OAuth callback received, exchanging code for tokens...');
            
            try {
                // Exchange authorization code for tokens
                const tokenResponse = await exchangeCodeForTokens(code);
                
                if (tokenResponse.access_token) {
                    // Get user information
                    const userInfo = await getUserInfo(tokenResponse.access_token);
                    
                    // Verify workspace membership
                    const isWorkspaceMember = await verifyWorkspaceMembership(tokenResponse.access_token);
                    
                    if (isWorkspaceMember) {
                        // Store authentication data
                        authState.isAuthenticated = true;
                        authState.accessToken = tokenResponse.access_token;
                        authState.refreshToken = tokenResponse.refresh_token;
                        authState.userEmail = userInfo.email;
                        authState.userId = userInfo.id;
                        
                        // Store in localStorage for persistence
                        localStorage.setItem('auth_token', tokenResponse.access_token);
                        localStorage.setItem('refresh_token', tokenResponse.refresh_token);
                        localStorage.setItem('user_email', userInfo.email);
                        localStorage.setItem('user_id', userInfo.id);
                        
                        console.log('üéâ Authentication successful!');
                        updateAuthUI();
                        
                        // Clean up URL and session storage
                        history.replaceState(null, null, window.location.pathname);
                        sessionStorage.removeItem('oauth_state');
                        sessionStorage.removeItem('oauth_code_verifier');
                        
                        return true;
                    } else {
                        console.error('‚ùå User is not a member of the target workspace');
                        showAuthError('Access denied: You are not a member of the J+D workspace.');
                        return false;
                    }
                } else {
                    console.error('‚ùå No access token received');
                    showAuthError('Authentication failed: No access token received');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Token exchange failed:', error);
                showAuthError('Authentication failed: ' + error.message);
                return false;
            }
        }
        
        async function exchangeCodeForTokens(code) {
            const codeVerifier = sessionStorage.getItem('oauth_code_verifier');
            
            const response = await fetch(`${OAUTH_CONFIG.airtableUrl}/oauth2/v1/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: OAUTH_CONFIG.clientId,
                    redirect_uri: OAUTH_CONFIG.redirectUri,
                    code: code,
                    code_verifier: codeVerifier
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error_description || 'Token exchange failed');
            }
            
            return response.json();
        }
        
        async function getUserInfo(accessToken) {
            // Note: Airtable's user info endpoint may vary - this is a placeholder
            // You may need to make a test API call to get user information
            const response = await fetch('https://api.airtable.com/v0/meta/whoami', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to get user information');
            }
            
            return response.json();
        }
        
        async function verifyWorkspaceMembership(accessToken) {
            // This is a placeholder - we'll implement workspace verification in Phase 3
            console.log('üìù Workspace verification - to be implemented in Phase 3');
            return true; // Temporary - accept all users for now
        }
        
        function showAuthError(message) {
            const overlay = document.getElementById('auth-overlay');
            const authMessage = overlay.querySelector('.auth-message');
            
            authMessage.innerHTML = `
                <h2>Authentication Error</h2>
                <p>${message}</p>
                <button id="retry-auth-btn" class="btn-auth">Try Again</button>
            `;
            
            document.getElementById('retry-auth-btn').addEventListener('click', () => {
                location.reload();
            });
        }
        
        function updateAuthUI() {
            const overlay = document.getElementById('auth-overlay');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const authLoading = document.getElementById('auth-loading');
            
            if (authState.isAuthenticated) {
                overlay.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmail.textContent = authState.userEmail;
                authLoading.classList.add('hidden');
                
                // Load partners now that user is authenticated
                console.log('Authentication complete - loading partners...');
                testAirtableAuth();
                loadExistingPartners();
            } else {
                overlay.classList.remove('hidden');
                userInfo.classList.add('hidden');
                authLoading.classList.add('hidden');
            }
        }
        
        function logout() {
            console.log('üö™ Logging out...');
            
            // Clear authentication state
            authState.isAuthenticated = false;
            authState.accessToken = null;
            authState.refreshToken = null;
            authState.userEmail = null;
            authState.userId = null;
            
            // Clear localStorage
            localStorage.removeItem('auth_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_id');
            
            // Update UI
            updateAuthUI();
        }
        
        function checkExistingAuth() {
            console.log('üîç Checking for existing authentication...');
            
            const token = localStorage.getItem('auth_token');
            const userEmail = localStorage.getItem('user_email');
            const userId = localStorage.getItem('user_id');
            
            if (token && userEmail && userId) {
                console.log('‚úÖ Found existing authentication');
                authState.isAuthenticated = true;
                authState.accessToken = token;
                authState.refreshToken = localStorage.getItem('refresh_token');
                authState.userEmail = userEmail;
                authState.userId = userId;
                updateAuthUI();
                return true;
            }
            
            console.log('‚ÑπÔ∏è No existing authentication found');
            return false;
        }
        
        // Application state
        const appState = {
            mapMode: 'view', // 'view', 'add', 'edit'
            selectedPartner: null,
            partners: [],
            currentBounds: null,
            zoomLevel: 4
        };
        
        // Airtable Configuration
        const AIRTABLE_CONFIG = {
            baseId: 'appwdh7OXsghNRy6k',
            tableName: 'Partners',
            apiUrl: 'https://api.airtable.com/v0'
            // Note: No longer using static API key - will use OAuth token from authState
        };
        
        // Wait for everything to load before initializing
        window.addEventListener('load', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            console.log('üöÄ Initializing J+D Partner Map...');
            
            // Setup authentication event listeners
            setupAuthEventListeners();
            
            // Check for existing authentication or OAuth callback
            const isCallback = await handleOAuthCallback();
            
            if (!isCallback) {
                checkExistingAuth();
            }
            
            // Initialize map regardless of auth status (will be hidden if not authenticated)
            initializeMap();
        }
        
        function setupAuthEventListeners() {
            // Login button click handler
            document.getElementById('airtable-login-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                
                if (OAUTH_CONFIG.clientId === 'INSERT_YOUR_CLIENT_ID') {
                    showAuthError('OAuth Client ID not configured. Please register your app at https://airtable.com/create/oauth');
                    return;
                }
                
                authState.isLoading = true;
                document.getElementById('auth-loading').classList.remove('hidden');
                
                await initiateOAuth();
            });
            
            // Logout button click handler
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
        
        function initializeMap() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library failed to load');
                document.getElementById('loading').textContent = 'Error: Map library failed to load. Please refresh the page.';
                return;
            }

            console.log('Initializing map...');

            // Initialize the map
            const map = L.map('map', {
                center: [39.8283, -98.5795], // Center of US
                zoom: 4,
                zoomControl: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                touchZoom: true
            });
            
            // Store map reference globally for partner functionality
            window.partnerMap = map;

            // Add tile layer with dark theme that includes city names
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Sample county data (in a real application, this would come from your Airtable API)
            // TODO: Replace this with actual Airtable API call when data is ready
            // This sample data prevents "undefined" popups while testing
            const sampleCountyData = {
                "Alabama": { population: 4921532, counties: 67, color: "#FF0064" },
                "Alaska": { population: 731158, counties: 29, color: "#50F5C8" },
                "Arizona": { population: 7421401, counties: 15, color: "#143CFF" },
                "Arkansas": { population: 3030522, counties: 75, color: "#DCF500" },
                "California": { population: 39129029, counties: 58, color: "#FF0064" },
                "Colorado": { population: 5812069, counties: 64, color: "#50F5C8" },
                "Connecticut": { population: 3563077, counties: 8, color: "#143CFF" },
                "Delaware": { population: 990837, counties: 3, color: "#DCF500" },
                "Florida": { population: 22610726, counties: 67, color: "#FF0064" },
                "Georgia": { population: 10788029, counties: 159, color: "#50F5C8" },
                "Hawaii": { population: 1406299, counties: 5, color: "#143CFF" },
                "Idaho": { population: 1896652, counties: 44, color: "#DCF500" },
                "Illinois": { population: 12620571, counties: 102, color: "#FF0064" },
                "Indiana": { population: 6842385, counties: 92, color: "#50F5C8" },
                "Iowa": { population: 3200517, counties: 99, color: "#143CFF" },
                "Kansas": { population: 2943456, counties: 105, color: "#DCF500" },
                "Kentucky": { population: 4526154, counties: 120, color: "#FF0064" },
                "Louisiana": { population: 4624047, counties: 64, color: "#50F5C8" },
                "Maine": { population: 1402989, counties: 16, color: "#143CFF" },
                "Maryland": { population: 6164660, counties: 23, color: "#DCF500" },
                "Massachusetts": { population: 7001399, counties: 14, color: "#FF0064" },
                "Michigan": { population: 10037261, counties: 83, color: "#50F5C8" },
                "Minnesota": { population: 5778793, counties: 87, color: "#143CFF" },
                "Mississippi": { population: 2940057, counties: 82, color: "#DCF500" },
                "Missouri": { population: 6201271, counties: 114, color: "#FF0064" },
                "Montana": { population: 1104271, counties: 56, color: "#50F5C8" },
                "Nebraska": { population: 1979654, counties: 93, color: "#143CFF" },
                "Nevada": { population: 3198399, counties: 16, color: "#DCF500" },
                "New Hampshire": { population: 1402054, counties: 10, color: "#FF0064" },
                "New Jersey": { population: 9290841, counties: 21, color: "#50F5C8" },
                "New Mexico": { population: 2114371, counties: 33, color: "#143CFF" },
                "New York": { population: 19300000, counties: 62, color: "#DCF500" },
                "North Carolina": { population: 10698973, counties: 100, color: "#FF0064" },
                "North Dakota": { population: 774948, counties: 53, color: "#50F5C8" },
                "Ohio": { population: 11812062, counties: 88, color: "#143CFF" },
                "Oklahoma": { population: 4019800, counties: 77, color: "#DCF500" },
                "Oregon": { population: 4301089, counties: 36, color: "#FF0064" },
                "Pennsylvania": { population: 12972008, counties: 67, color: "#50F5C8" },
                "Rhode Island": { population: 1095610, counties: 5, color: "#143CFF" },
                "South Carolina": { population: 5373555, counties: 46, color: "#DCF500" },
                "South Dakota": { population: 919318, counties: 66, color: "#FF0064" },
                "Tennessee": { population: 7051339, counties: 95, color: "#50F5C8" },
                "Texas": { population: 30503301, counties: 254, color: "#143CFF" },
                "Utah": { population: 3380800, counties: 29, color: "#DCF500" },
                "Vermont": { population: 647464, counties: 14, color: "#FF0064" },
                "Virginia": { population: 8715698, counties: 95, color: "#50F5C8" },
                "Washington": { population: 7812880, counties: 39, color: "#143CFF" },
                "West Virginia": { population: 1775156, counties: 55, color: "#DCF500" },
                "Wisconsin": { population: 5895908, counties: 72, color: "#FF0064" },
                "Wyoming": { population: 582233, counties: 23, color: "#50F5C8" }
            };

            // Style function for state polygons
            function style(feature) {
                const stateName = feature.properties.NAME;
                const stateData = sampleCountyData[stateName];
                
                return {
                    fillColor: stateData ? stateData.color : '#FF0064',
                    weight: 1,
                    opacity: 0.8,
                    color: '#E1E1E1',
                    fillOpacity: 0.3,
                    dashArray: ''
                };
            }

            // Hover effect
            function highlightFeature(e) {
                const layer = e.target;
                
                layer.setStyle({
                    weight: 2,
                    color: '#FF0064',
                    fillOpacity: 0.6
                });

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
            }

            function resetHighlight(e) {
                geojson.resetStyle(e.target);
            }

            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            function onEachFeature(feature, layer) {
                // Only bind click event - no popups or hover effects for states
                layer.on({
                    click: zoomToFeature
                });
            }

            // Load simplified US states GeoJSON (as a starting point)
            let geojson;

            // Sample GeoJSON for demonstration (simplified states)
            fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('GeoJSON data loaded successfully');
                    document.getElementById('loading').style.display = 'none';
                    
                    geojson = L.geoJson(data, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    
                    console.log('State boundaries loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading map data:', error);
                    document.getElementById('loading').textContent = 'Error loading map data. Showing demo marker instead.';
                    
                    // Create a simple fallback marker for demonstration
                    L.marker([39.8283, -98.5795])
                        .addTo(map)
                        .bindPopup(`
                            <div class="county-info">
                                <h3>Demo Map</h3>
                                <p>County-level data would be loaded here</p>
                                <p>Connected to Airtable API for real data</p>
                                <p>GeoJSON loading failed - using fallback marker</p>
                            </div>
                        `);
                });

            // Map event handlers  
            map.on('zoomend', function() {
                const zoom = map.getZoom();
                // Map tiles will naturally show city names at higher zoom levels
            });
            
            // Add map click handler for partner placement
            map.on('click', function(e) {
                console.log('Map clicked at:', e.latlng);
                
                // Only handle clicks in add mode
                if (appState.mapMode === 'add') {
                    console.log('Add mode active - placing partner at:', e.latlng);
                    handleAddPartnerClick(e);
                } else {
                    console.log('Not in add mode, ignoring click');
                }
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                map.invalidateSize();
            });

            // Add custom control for data source info
            const dataControl = L.control({position: 'bottomright'});
            dataControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'data-source');
                div.innerHTML = '<div style="background-color: rgba(55,55,55,0.9); padding: 10px; border: 1px solid #FF0064; font-family: Monaco, monospace; font-size: 10px; color: #E1E1E1;">Data Source: Airtable API<br>Map: Leaflet + OpenStreetMap</div>';
                return div;
            };
            dataControl.addTo(map);

            // Initialize partner management system
            window.partnerManager = new PartnerManager(map);
            
            // Initialize add partner button
            initializePartnerControls();
            
            // Initialize form submission handler
            document.getElementById('partner-form').addEventListener('submit', handlePartnerFormSubmit);
            
            // Load existing partners from Airtable only if authenticated
            if (authState.isAuthenticated) {
                console.log('User authenticated - loading existing partners...');
                testAirtableAuth();
                loadExistingPartners();
            } else {
                console.log('User not authenticated - skipping partner loading');
            }
            
            console.log('Map initialization complete');
        }
        
        // Test Airtable authentication
        async function testAirtableAuth() {
            console.log('Testing Airtable authentication...');
            console.log('Base ID:', AIRTABLE_CONFIG.baseId);
            console.log('Table Name:', AIRTABLE_CONFIG.tableName);
            console.log('Using OAuth Token for authenticated requests');
            
            const testUrl = `${AIRTABLE_CONFIG.apiUrl}/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}?maxRecords=1`;
            
            try {
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authState.accessToken}`
                    }
                });
                
                console.log('Auth test response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Airtable authentication successful!');
                    console.log('Found records:', data.records?.length || 0);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Airtable authentication failed:');
                    console.error('Status:', response.status, response.statusText);
                    console.error('Error:', errorText);
                    
                    // If it's a 404, might be wrong table name - let's try to list all tables
                    if (response.status === 404) {
                        console.log('Trying to fetch base metadata to see available tables...');
                        try {
                            const metaResponse = await fetch(`https://api.airtable.com/v0/meta/bases/${AIRTABLE_CONFIG.baseId}/tables`, {
                                headers: { 'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}` }
                            });
                            if (metaResponse.ok) {
                                const metaData = await metaResponse.json();
                                console.log('Available tables:', metaData.tables?.map(t => t.name));
                            }
                        } catch (e) {
                            console.log('Could not fetch table metadata');
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Airtable request failed:', error);
            }
        }
        
        // Load existing partners from Airtable and add to map
        async function loadExistingPartners() {
            console.log('Loading existing partners from Airtable...');
            
            const result = await loadPartnersFromAirtable();
            
            if (result.success && result.partners.length > 0) {
                console.log(`‚úÖ Loaded ${result.partners.length} existing partners from Airtable`);
                
                result.partners.forEach(partner => {
                    // Only create marker if partner has valid coordinates
                    if (partner.latitude && partner.longitude && 
                        !isNaN(partner.latitude) && !isNaN(partner.longitude)) {
                        // Use partnerManager to add markers so they participate in clustering
                        if (window.partnerManager) {
                            window.partnerManager.addPartnerMarker(partner);
                        } else {
                            // Fallback to direct marker creation if partnerManager not available
                            createPermanentPartnerMarker(partner);
                        }
                    } else {
                        console.warn('Skipping partner with invalid coordinates:', partner.name, 
                            'Lat:', partner.latitude, 'Lng:', partner.longitude);
                    }
                });
                
                // Partners loaded successfully - they'll appear at their locations on the map
                console.log(`‚úÖ ${result.partners.filter(p => p.latitude && p.longitude && !isNaN(p.latitude) && !isNaN(p.longitude)).length} partners with valid coordinates added to map`);
                
            } else if (result.success && result.partners.length === 0) {
                console.log('‚úÖ No existing partners found in Airtable');
            } else {
                console.log('‚ùå Could not load existing partners:', result.message || 'Unknown error');
            }
        }
        
        // Airtable API Helper Functions
        async function createPartnerInAirtable(partnerData) {
            if (!authState.isAuthenticated || !authState.accessToken) {
                console.warn('Airtable API key not configured. Partner saved locally only.');
                return { success: false, message: 'API key required' };
            }
            
            const url = `${AIRTABLE_CONFIG.apiUrl}/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
            
            const airtableRequest = {
                records: [
                    {
                        fields: {
                            "Partner Name": partnerData.name,
                            "Partner Type": partnerData.type,
                            "Address": partnerData.address || '',
                            "Description": partnerData.description || '',
                            "Contact": partnerData.contactPerson || '',
                            "Contact Email": partnerData.contactEmail || '',
                            "Contact Phone": partnerData.contactPhone || '',
                            "Project Tracking Link": partnerData.projectLink || '',
                            "Notes": partnerData.notes || '',
                            "Latitude": partnerData.latitude,
                            "Longitude": partnerData.longitude
                        }
                    }
                ]
            };
            
            try {
                const headers = {
                    'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                    'Content-Type': 'application/json'
                };
                
                console.log('Request headers:', {
                    'Authorization': `Bearer ${authState.accessToken}`,
                    'Content-Type': 'application/json'
                });
                console.log('Request body:', JSON.stringify(airtableRequest, null, 2));
                console.log('Field values and types:');
                Object.entries(airtableRequest.records[0].fields).forEach(([key, value]) => {
                    console.log(`  ${key}: "${value}" (${typeof value})`);
                });
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(airtableRequest)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Partner created in Airtable:', result);
                    return { success: true, data: result };
                } else {
                    const errorText = await response.text();
                    console.error('Airtable API error:', response.status, response.statusText);
                    console.error('Error details:', errorText);
                    console.error('Request URL:', url);
                    console.error('Using OAuth authentication token');
                    return { success: false, message: `API error: ${response.status} - ${errorText}` };
                }
            } catch (error) {
                console.error('Airtable request failed:', error);
                return { success: false, message: error.message };
            }
        }
        
        async function loadPartnersFromAirtable() {
            if (!authState.isAuthenticated || !authState.accessToken) {
                console.warn('User not authenticated. Cannot load partners.');
                return { success: false, partners: [] };
            }
            
            const url = `${AIRTABLE_CONFIG.apiUrl}/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authState.accessToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const partners = result.records.map(record => ({
                        id: record.id,
                        name: record.fields["Partner Name"],
                        type: record.fields["Partner Type"],
                        address: record.fields["Address"] || '',
                        latitude: record.fields["Latitude"],
                        longitude: record.fields["Longitude"],
                        contactPerson: record.fields["Contact"] || '',
                        contactEmail: record.fields["Contact Email"] || '',
                        contactPhone: record.fields["Contact Phone"] || '',
                        description: record.fields["Description"] || '',
                        projectLink: record.fields["Project Tracking Link"] || '',
                        notes: record.fields["Notes"] || '',
                        createdAt: record.createdTime
                    }));
                    
                    console.log('Partners loaded from Airtable:', partners.length);
                    return { success: true, partners: partners };
                } else {
                    console.error('Airtable API error:', response.status, response.statusText);
                    return { success: false, partners: [] };
                }
            } catch (error) {
                console.error('Airtable request failed:', error);
                return { success: false, partners: [] };
            }
        }
        
        async function updatePartnerInAirtable(partnerId, partnerData) {
            if (!authState.isAuthenticated || !authState.accessToken) {
                console.warn('User not authenticated. Cannot update partner.');
                return { success: false, message: 'Authentication required' };
            }
            
            const url = `${AIRTABLE_CONFIG.apiUrl}/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${partnerId}`;
            
            const airtableRecord = {
                fields: {
                    name: partnerData.name,
                    type: partnerData.type,
                    address: partnerData.address || '',
                    latitude: partnerData.latitude,
                    longitude: partnerData.longitude,
                    contact_person: partnerData.contactPerson || '',
                    contact_email: partnerData.contactEmail || '',
                    description: partnerData.description || '',
                    website: partnerData.website || '',
                    state: partnerData.state || '',
                    county: partnerData.county || ''
                }
            };
            
            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authState.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(airtableRecord)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Partner updated in Airtable:', result);
                    return { success: true, data: result };
                } else {
                    console.error('Airtable API error:', response.status, response.statusText);
                    return { success: false, message: `API error: ${response.status}` };
                }
            } catch (error) {
                console.error('Airtable request failed:', error);
                return { success: false, message: error.message };
            }
        }
        
        async function deletePartnerFromAirtable(partnerId) {
            if (!authState.isAuthenticated || !authState.accessToken) {
                console.warn('Airtable API key not configured.');
                return { success: false, message: 'API key required' };
            }
            
            const url = `${AIRTABLE_CONFIG.apiUrl}/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${partnerId}`;
            
            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authState.accessToken}`
                    }
                });
                
                if (response.ok) {
                    console.log('Partner deleted from Airtable:', partnerId);
                    return { success: true };
                } else {
                    console.error('Airtable API error:', response.status, response.statusText);
                    return { success: false, message: `API error: ${response.status}` };
                }
            } catch (error) {
                console.error('Airtable request failed:', error);
                return { success: false, message: error.message };
            }
        }
        
        
        // Handle map clicks for adding partners
        function handleAddPartnerClick(e) {
            const { lat, lng } = e.latlng;
            console.log('Creating partner at:', lat, lng);
            
            if (!window.partnerMap) {
                console.error('partnerMap is undefined!');
                return;
            }
            
            // Create temporary marker
            const tempMarker = L.marker([lat, lng], {
                draggable: true,
                opacity: 0.7
            }).addTo(window.partnerMap);
            
            // Store coordinates and marker reference
            window.currentPartnerCoords = { lat, lng };
            window.currentTempMarker = tempMarker;
            
            // Open modal with coordinates pre-filled
            openPartnerModal(lat, lng);
        }
        
        // Open partner modal
        function openPartnerModal(lat, lng) {
            const modal = document.getElementById('partner-modal');
            
            // Pre-fill coordinates
            document.getElementById('partner-lat').value = lat.toFixed(6);
            document.getElementById('partner-lng').value = lng.toFixed(6);
            
            // Clear other fields
            document.getElementById('partner-name').value = '';
            document.getElementById('partner-type').value = '';
            document.getElementById('partner-address').value = '';
            document.getElementById('partner-description').value = '';
            document.getElementById('partner-contact').value = '';
            document.getElementById('partner-email').value = '';
            document.getElementById('partner-phone').value = '';
            document.getElementById('partner-project-link').value = '';
            document.getElementById('partner-notes').value = '';
            document.getElementById('geocoding-status').innerHTML = '';
            
            // Show modal
            modal.classList.add('visible');
            
            // Focus on name field
            setTimeout(() => {
                document.getElementById('partner-name').focus();
            }, 100);
        }
        
        // Show save progress feedback
        function showSaveProgress(message, type = 'info') {
            const progressEl = document.getElementById('save-progress');
            const saveBtn = document.getElementById('save-partner-btn');
            
            if (progressEl) {
                progressEl.textContent = message;
                progressEl.className = `save-progress ${type}`;
                progressEl.classList.remove('hidden');
                
                // Disable save button while processing
                if (type === 'info' && saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                } else if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Partner';
                }
            }
        }
        
        // Close partner modal
        function closePartnerModal() {
            const modal = document.getElementById('partner-modal');
            modal.classList.remove('visible');
            
            // Hide progress indicator
            const progressEl = document.getElementById('save-progress');
            if (progressEl) {
                progressEl.classList.add('hidden');
            }
            
            // Re-enable save button
            const saveBtn = document.getElementById('save-partner-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Partner';
            }
            
            // Clean up temporary marker
            if (window.currentTempMarker) {
                window.partnerMap.removeLayer(window.currentTempMarker);
                delete window.currentTempMarker;
            }
            
            // Exit add mode
            appState.mapMode = 'view';
            updateUIForMode();
        }
        
        // Geocode address to coordinates
        function geocodeAddress() {
            const address = document.getElementById('partner-address').value.trim();
            const statusDiv = document.getElementById('geocoding-status');
            
            if (!address) {
                statusDiv.innerHTML = '<span class="geocoding-error">Please enter an address</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #DCF500;">Geocoding...</span>';
            
            // Use Nominatim geocoding service (OpenStreetMap)
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
            
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        
                        // Update coordinate fields
                        document.getElementById('partner-lat').value = lat.toFixed(6);
                        document.getElementById('partner-lng').value = lng.toFixed(6);
                        
                        // Update temporary marker position
                        if (window.currentTempMarker) {
                            window.currentTempMarker.setLatLng([lat, lng]);
                            window.partnerMap.setView([lat, lng], 12);
                        }
                        
                        statusDiv.innerHTML = `<span class="geocoding-success">‚úì Found: ${result.display_name}</span>`;
                        
                        console.log('Geocoding successful:', { lat, lng, address: result.display_name });
                        
                    } else {
                        statusDiv.innerHTML = '<span class="geocoding-error">Address not found. Try a different format.</span>';
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    statusDiv.innerHTML = '<span class="geocoding-error">Geocoding service unavailable</span>';
                });
        }
        
        // Handle form submission
        async function handlePartnerFormSubmit(event) {
            event.preventDefault();
            
            // Show saving feedback
            showSaveProgress('Saving partner...');
            
            const formData = new FormData(event.target);
            const name = formData.get('name');
            const type = formData.get('type');
            const address = formData.get('address');
            const latitude = parseFloat(formData.get('latitude'));
            const longitude = parseFloat(formData.get('longitude'));
            
            // Get all the additional fields
            const description = formData.get('description');
            const contactPerson = formData.get('contact');
            const contactEmail = formData.get('contactEmail');
            const contactPhone = formData.get('contactPhone');
            const projectLink = formData.get('projectLink');
            const notes = formData.get('notes');
            
            // Validate required fields
            if (!name || !type) {
                showSaveProgress('Error: Please fill in required fields', 'error');
                return;
            }
            
            if (!latitude || !longitude) {
                showSaveProgress('Error: Please ensure coordinates are set', 'error');
                return;
            }
            
            // Create partner data with all fields
            const partnerData = {
                id: Date.now().toString(), // Temporary local ID
                name: name,
                type: type,
                address: address || '',
                description: description || '',
                contactPerson: contactPerson || '',
                contactEmail: contactEmail || '',
                contactPhone: contactPhone || '',
                projectLink: projectLink || '',
                notes: notes || '',
                latitude: latitude,
                longitude: longitude,
                createdAt: new Date().toISOString()
            };
            
            console.log('Saving partner with all fields:', partnerData);
            
            // Update progress
            showSaveProgress('Connecting to Airtable...');
            
            // Try to save to Airtable
            const airtableResult = await createPartnerInAirtable(partnerData);
            
            if (airtableResult.success) {
                // Use Airtable record ID if successful
                partnerData.id = airtableResult.data.id;
                partnerData.createdAt = airtableResult.data.createdTime;
                console.log('Partner saved to Airtable with ID:', partnerData.id);
                showSaveProgress('‚úÖ Partner saved successfully!', 'success');
                
                // Create permanent marker using partnerManager for clustering support
                if (window.partnerManager) {
                    window.partnerManager.addPartnerMarker(partnerData);
                } else {
                    createPermanentPartnerMarker(partnerData);
                }
                
                // Close modal after a short delay to show success message
                setTimeout(() => {
                    closePartnerModal();
                }, 1500);
            } else {
                console.log('Partner saved locally only:', airtableResult.message);
                showSaveProgress('‚ùå Failed to save to Airtable: ' + airtableResult.message, 'error');
                
                // Still create marker locally using partnerManager for clustering support
                if (window.partnerManager) {
                    window.partnerManager.addPartnerMarker(partnerData);
                } else {
                    createPermanentPartnerMarker(partnerData);
                }
                
                // Don't auto-close on error, let user decide
            }
        }
        
        
        // Create permanent partner marker
        function createPermanentPartnerMarker(partnerData) {
            // Get marker style based on partner type
            const markerOptions = getPartnerMarkerStyle(partnerData.type);
            
            // Create the marker
            const marker = L.marker([partnerData.latitude, partnerData.longitude], markerOptions)
                .addTo(window.partnerMap);
            
            // Create popup content
            const popupContent = createPartnerDisplayPopup(partnerData);
            marker.bindPopup(popupContent);
            
            console.log('Created permanent partner marker:', partnerData);
            return marker;
        }
        
        // Get marker style based on partner type
        function getPartnerMarkerStyle(type) {
            const iconHtml = getPartnerIconHtml(type);
            
            return {
                icon: L.divIcon({
                    html: iconHtml,
                    className: 'partner-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                })
            };
        }
        
        // Get icon HTML for different partner types using J+D brand colors
        function getPartnerIconHtml(type) {
            const styles = {
                "Connector": { color: '#FF0064', shape: 'circle' },           // J+D Pink - Connectors
                "Information Hub": { color: '#50F5C8', shape: 'diamond' },     // J+D Aqua - Information Hubs  
                "Funder": { color: '#DCF500', shape: 'diamond' },              // J+D Yellow - Funders
                "News Organization": { color: '#50F5C8', shape: 'diamond' },   // J+D Aqua - News Organizations
                "Community College": { color: '#143CFF', shape: 'square' },    // J+D Blue - Community Colleges
                "Library": { color: '#FF0064', shape: 'circle' },            // J+D Pink - Libraries
                "Other": { color: '#FF0064', shape: 'triangle' }                // J+D Pink - Other
            };
            
            const style = styles[type] || styles["Other"];
            
            let shapeStyles = '';
            switch(style.shape) {
                case 'circle':
                    shapeStyles = `background-color: ${style.color}; width: 16px; height: 16px; border-radius: 50%; border: 1px solid white; box-sizing: border-box;`;
                    break;
                case 'square':
                    shapeStyles = `background-color: ${style.color}; width: 16px; height: 16px; border: 1px solid white; box-sizing: border-box;`;
                    break;
                case 'diamond':
                    shapeStyles = `background-color: ${style.color}; width: 12px; height: 12px; border: 1px solid white; transform: rotate(45deg); box-sizing: border-box;`;
                    break;
                case 'triangle':
                    shapeStyles = `width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 14px solid ${style.color}; filter: drop-shadow(0 0 0 1px white);`;
                    break;
                default:
                    shapeStyles = `background-color: ${style.color}; width: 16px; height: 16px; border-radius: 50%; border: 1px solid white; box-sizing: border-box;`;
            }
            
            return `<div style="${shapeStyles}"></div>`;
        }
        
        // Create display popup for existing partners
        function createPartnerDisplayPopup(partner) {
            // Type labels mapping
            const typeLabels = {
                "Connector": 'Connector',
                "Information Hub": 'Information Hub',
                "Funder": 'Funder',
                "News Organization": 'News Organization',
                "Community College": 'Community College',
                "Library": 'Library',
                "Other": 'Other'
            };
            
            // Define all possible fields and their display labels (excluding coordinates)
            const fieldMappings = {
                'type': { label: 'Type', value: typeLabels[partner.type] || partner.type },
                'address': { label: 'Address', value: partner.address },
                'description': { label: 'Description', value: partner.description },
                'contactPerson': { label: 'Contact Person', value: partner.contactPerson },
                'contactEmail': { label: 'Contact Email', value: partner.contactEmail },
                'contactPhone': { label: 'Contact Phone', value: partner.contactPhone },
                'projectLink': { label: 'Project Tracking', value: partner.projectLink },
                'notes': { label: 'Notes', value: partner.notes }
            };
            
            // Build popup content dynamically for fields with values
            let popupContent = `<div class="county-info"><h3>${partner.name}</h3>`;
            
            // Add each field that has a value
            Object.entries(fieldMappings).forEach(([key, field]) => {
                if (field.value && field.value.trim() !== '') {
                    if (key === 'projectLink') {
                        // Make project links clickable
                        popupContent += `<p><strong>${field.label}:</strong> <a href="${field.value}" target="_blank" style="color: #FF0064;">${field.value}</a></p>`;
                    } else if (key === 'contactEmail') {
                        // Make emails clickable
                        popupContent += `<p><strong>${field.label}:</strong> <a href="mailto:${field.value}" style="color: #FF0064;">${field.value}</a></p>`;
                    } else if (key === 'description' || key === 'notes') {
                        // Show longer text fields with word wrapping
                        popupContent += `<p><strong>${field.label}:</strong><br><span style="font-size: 13px;">${field.value}</span></p>`;
                    } else {
                        // Standard field display
                        popupContent += `<p><strong>${field.label}:</strong> ${field.value}</p>`;
                    }
                }
            });
            
            // Add edit/delete buttons
            popupContent += `
                <div style="margin-top: 10px;">
                    <button onclick="editPartner('${partner.id}')" style="background: #143CFF; color: white; border: none; padding: 5px 10px; margin-right: 5px; cursor: pointer; font-size: 11px; border-radius: 3px;">Edit</button>
                    <button onclick="deletePartner('${partner.id}')" style="background: #666; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; border-radius: 3px;">Delete</button>
                </div>
            </div>`;
            
            return popupContent;
        }
        
        // Placeholder functions for edit/delete (Phase 2)
        function editPartner(partnerId) {
            alert(`Edit functionality coming in Phase 2!\nPartner ID: ${partnerId}`);
        }
        
        function deletePartner(partnerId) {
            if (confirm('Delete this partner?')) {
                alert(`Delete functionality coming in Phase 2!\nPartner ID: ${partnerId}`);
            }
        }
        
        // Update UI based on current mode
        function updateUIForMode() {
            const addBtn = document.getElementById('add-partner-btn');
            const modeIndicator = document.getElementById('mode-indicator');
            const mapElement = document.getElementById('map');
            
            if (appState.mapMode === 'add') {
                addBtn.classList.add('active');
                addBtn.innerHTML = 'Exit Add Mode';
                addBtn.title = 'Exit Add Partner Mode';
                if (modeIndicator) modeIndicator.classList.add('visible');
                if (mapElement) {
                    mapElement.style.cursor = 'crosshair';
                    mapElement.classList.add('add-mode');
                }
                if (window.partnerMap) {
                    window.partnerMap.getContainer().style.cursor = 'crosshair';
                }
            } else {
                addBtn.classList.remove('active');
                addBtn.innerHTML = 'Add Partner';
                addBtn.title = 'Toggle Add Partner Mode';
                if (modeIndicator) modeIndicator.classList.remove('visible');
                if (mapElement) {
                    mapElement.style.cursor = '';
                    mapElement.classList.remove('add-mode');
                }
                if (window.partnerMap) {
                    window.partnerMap.getContainer().style.cursor = '';
                }
            }
        }
        
        // Initialize partner-related UI controls
        function initializePartnerControls() {
            const addBtn = document.getElementById('add-partner-btn');
            const modeIndicator = document.getElementById('mode-indicator');
            
            console.log('Initializing partner controls...');
            console.log('Add button found:', addBtn);
            console.log('Mode indicator found:', modeIndicator);
            
            if (!addBtn) {
                console.error('Add partner button not found!');
                return;
            }
            
            addBtn.addEventListener('click', function() {
                console.log('Add button clicked!');
                toggleAddMode();
            });
            
            function toggleAddMode() {
                console.log('Toggle add mode called. Current mode:', appState.mapMode);
                
                if (appState.mapMode === 'add') {
                    // Exit add mode
                    appState.mapMode = 'view';
                    
                    // Remove any temporary markers
                    if (window.currentTempMarker) {
                        window.partnerMap.removeLayer(window.currentTempMarker);
                        delete window.currentTempMarker;
                    }
                } else {
                    // Enter add mode
                    console.log('Entering add mode...');
                    appState.mapMode = 'add';
                }
                
                // Update UI using centralized function
                updateUIForMode();
            }
        }
    </script>
</body>
</html>